#!/usr/bin/env lua
--[[
    makelove - Standalone build script for LÖVE 2D games

    Usage: lua makelove [windows|mac|linux]

    If no arguments are provided, builds for all platforms.
    Executables are created at the root of the repository.
--]]

local GAME_NAME = "lasagna"
local LOVE_VERSION = "11.4"

-- Platform-specific LÖVE download URLs
local LOVE_URLS = {
    windows = "https://github.com/love2d/love/releases/download/" .. LOVE_VERSION .. "/love-" .. LOVE_VERSION .. "-win64.zip",
    mac = "https://github.com/love2d/love/releases/download/" .. LOVE_VERSION .. "/love-" .. LOVE_VERSION .. "-macos.zip",
    linux = "https://github.com/love2d/love/releases/download/" .. LOVE_VERSION .. "/love-" .. LOVE_VERSION .. "-x86_64.AppImage"
}

-- Utility functions

local function log(msg)
    print("[makelove] " .. msg)
end

local function run(cmd)
    log("Running: " .. cmd)
    local result = os.execute(cmd)
    if type(result) == "number" then
        return result == 0
    else
        return result
    end
end

local function file_exists(path)
    local f = io.open(path, "r")
    if f then
        f:close()
        return true
    end
    return false
end

local function dir_exists(path)
    local ok, err, code = os.rename(path, path)
    if ok then return true end
    if code == 13 then return true end  -- Permission denied, but exists
    return false
end

local function mkdir(path)
    if not dir_exists(path) then
        run("mkdir -p " .. path)
    end
end

local function rmdir(path)
    if dir_exists(path) then
        run("rm -rf " .. path)
    end
end

-- Create the .love file (zip archive of the project)
local function create_love_file()
    local love_file = GAME_NAME .. ".love"
    log("Creating " .. love_file .. "...")

    -- Remove old .love file if it exists
    if file_exists(love_file) then
        os.remove(love_file)
    end

    -- Create zip with all project files, excluding unwanted files
    -- We use a temporary file list to handle exclusions
    local cmd = "zip -9 -r " .. love_file .. " . "
    for _, pattern in ipairs({
        ".git/*", ".github/*", ".gitignore", ".editorconfig",
        "README.md", "ROADMAP.md", "makelove",
        GAME_NAME .. ".love",
        GAME_NAME .. "-windows.zip",
        GAME_NAME .. "-mac.zip",
        GAME_NAME .. "-linux.tar.gz",
        "build/*", ".love-cache/*"
    }) do
        cmd = cmd .. "-x '" .. pattern .. "' "
    end

    if not run(cmd) then
        log("ERROR: Failed to create .love file")
        return false
    end

    log("Created " .. love_file)
    return true
end

-- Download LÖVE for a specific platform
local function download_love(platform)
    local cache_dir = ".love-cache"
    mkdir(cache_dir)

    local url = LOVE_URLS[platform]
    if not url then
        log("ERROR: Unknown platform: " .. platform)
        return nil
    end

    local filename
    if platform == "linux" then
        filename = cache_dir .. "/love-" .. LOVE_VERSION .. "-x86_64.AppImage"
    else
        filename = cache_dir .. "/love-" .. LOVE_VERSION .. "-" .. platform .. ".zip"
    end

    if not file_exists(filename) then
        log("Downloading LÖVE " .. LOVE_VERSION .. " for " .. platform .. "...")
        local cmd = "curl -L -o " .. filename .. " " .. url
        if not run(cmd) then
            log("ERROR: Failed to download LÖVE for " .. platform)
            return nil
        end
    else
        log("Using cached LÖVE for " .. platform)
    end

    return filename
end

-- Build for Windows
local function build_windows()
    log("Building for Windows...")

    local love_file = GAME_NAME .. ".love"
    if not file_exists(love_file) then
        log("ERROR: " .. love_file .. " not found. Run create_love_file first.")
        return false
    end

    -- Download LÖVE for Windows
    local love_zip = download_love("windows")
    if not love_zip then return false end

    local build_dir = "build/windows"
    rmdir(build_dir)
    mkdir(build_dir)

    -- Extract LÖVE
    log("Extracting LÖVE for Windows...")
    if not run("unzip -q " .. love_zip .. " -d build/") then
        log("ERROR: Failed to extract LÖVE")
        return false
    end

    -- Find the extracted directory
    local love_dir = "build/love-" .. LOVE_VERSION .. "-win64"
    if not dir_exists(love_dir) then
        log("ERROR: Expected directory not found: " .. love_dir)
        return false
    end

    -- Move contents to build/windows
    run("mv " .. love_dir .. "/* " .. build_dir .. "/")
    rmdir(love_dir)

    -- Combine love.exe with the .love file
    log("Creating Windows executable...")
    if not run("cat " .. build_dir .. "/love.exe " .. love_file .. " > " .. build_dir .. "/" .. GAME_NAME .. ".exe") then
        log("ERROR: Failed to create Windows executable")
        return false
    end

    -- Remove the original love.exe
    os.remove(build_dir .. "/love.exe")
    os.remove(build_dir .. "/lovec.exe")

    -- Create the final zip
    local output_file = GAME_NAME .. "-windows.zip"
    if file_exists(output_file) then
        os.remove(output_file)
    end

    log("Creating " .. output_file .. "...")
    if not run("cd build && zip -9 -r ../" .. output_file .. " windows/") then
        log("ERROR: Failed to create Windows zip")
        return false
    end

    -- Cleanup
    rmdir("build/windows")

    log("Created " .. output_file)
    return true
end

-- Build for macOS
local function build_mac()
    log("Building for macOS...")

    local love_file = GAME_NAME .. ".love"
    if not file_exists(love_file) then
        log("ERROR: " .. love_file .. " not found. Run create_love_file first.")
        return false
    end

    -- Download LÖVE for macOS
    local love_zip = download_love("mac")
    if not love_zip then return false end

    local build_dir = "build/mac"
    rmdir(build_dir)
    mkdir(build_dir)

    -- Extract LÖVE
    log("Extracting LÖVE for macOS...")
    if not run("unzip -q " .. love_zip .. " -d " .. build_dir .. "/") then
        log("ERROR: Failed to extract LÖVE")
        return false
    end

    -- The macOS version extracts to love.app
    local app_path = build_dir .. "/love.app"
    local new_app_path = build_dir .. "/" .. GAME_NAME .. ".app"

    if not dir_exists(app_path) then
        log("ERROR: love.app not found in extracted archive")
        return false
    end

    -- Rename the app
    run("mv " .. app_path .. " " .. new_app_path)

    -- Copy the .love file into the app bundle
    log("Creating macOS app bundle...")
    local resources_dir = new_app_path .. "/Contents/Resources"
    if not run("cp " .. love_file .. " " .. resources_dir .. "/" .. GAME_NAME .. ".love") then
        log("ERROR: Failed to copy .love file into app bundle")
        return false
    end

    -- Create the final zip
    local output_file = GAME_NAME .. "-mac.zip"
    if file_exists(output_file) then
        os.remove(output_file)
    end

    log("Creating " .. output_file .. "...")
    if not run("cd " .. build_dir .. " && zip -9 -r -y ../../" .. output_file .. " " .. GAME_NAME .. ".app") then
        log("ERROR: Failed to create macOS zip")
        return false
    end

    -- Cleanup
    rmdir(build_dir)

    log("Created " .. output_file)
    return true
end

-- Build for Linux
local function build_linux()
    log("Building for Linux...")

    local love_file = GAME_NAME .. ".love"
    if not file_exists(love_file) then
        log("ERROR: " .. love_file .. " not found. Run create_love_file first.")
        return false
    end

    -- Download LÖVE AppImage for Linux
    local love_appimage = download_love("linux")
    if not love_appimage then return false end

    local build_dir = "build/linux"
    rmdir(build_dir)
    mkdir(build_dir)

    -- Copy the AppImage and make it executable
    local appimage_dest = build_dir .. "/love"
    if not run("cp " .. love_appimage .. " " .. appimage_dest) then
        log("ERROR: Failed to copy AppImage")
        return false
    end
    run("chmod +x " .. appimage_dest)

    -- Copy the .love file
    run("cp " .. love_file .. " " .. build_dir .. "/" .. GAME_NAME .. ".love")

    -- Create a launcher script
    local launcher_script = build_dir .. "/" .. GAME_NAME
    local f = io.open(launcher_script, "w")
    if f then
        f:write("#!/bin/bash\n")
        f:write("SCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n")
        f:write("\"$SCRIPT_DIR/love\" \"$SCRIPT_DIR/" .. GAME_NAME .. ".love\" \"$@\"\n")
        f:close()
        run("chmod +x " .. launcher_script)
    end

    -- Create the final tar.gz
    local output_file = GAME_NAME .. "-linux.tar.gz"
    if file_exists(output_file) then
        os.remove(output_file)
    end

    log("Creating " .. output_file .. "...")
    if not run("cd build && tar -czf ../" .. output_file .. " linux/") then
        log("ERROR: Failed to create Linux tar.gz")
        return false
    end

    -- Cleanup
    rmdir(build_dir)

    log("Created " .. output_file)
    return true
end

-- Clean up build artifacts
local function clean()
    log("Cleaning up...")
    rmdir("build")
    rmdir(".love-cache")
    if file_exists(GAME_NAME .. ".love") then
        os.remove(GAME_NAME .. ".love")
    end
    if file_exists(GAME_NAME .. "-windows.zip") then
        os.remove(GAME_NAME .. "-windows.zip")
    end
    if file_exists(GAME_NAME .. "-mac.zip") then
        os.remove(GAME_NAME .. "-mac.zip")
    end
    if file_exists(GAME_NAME .. "-linux.tar.gz") then
        os.remove(GAME_NAME .. "-linux.tar.gz")
    end
    log("Clean complete")
end

local function check()
    log("Checking...")
    if not run("find . -type f -name '*.lua' | xargs luacheck --no-global") then
        log("ERROR: Failed to luacheck")
        return false
    end
    return true
end

local function tests()
    log("Testing...")
    if not run("lua ./tests/log.lua >/dev/null") then return false end
    if not run("lua ./tests/states.lua >/dev/null") then return false end
    log("Tests: all tests completed.")
    return true
end

-- Print usage
local function print_usage()
    print("Usage: lua makelove [...]")
    print("       check   -- Runs luacheck on codebase")
    print("       tests   -- Runs ./tests/*")
    print("       windows -- Build for Windows (zip with love.exe)")
    print("       mac     -- Build for macOS (app bundle)")
    print("       linux   -- Build for Linux (tar.gz with love binary)")
    print("       all     -- Builds for all platforms.")
    print("       clean   -- Remove all build artifacts")
end

-- Main entry point
local function main(args)
    local target = args[1]

    if target == nil or target == "help" then
        print_usage()
        return 0
    end

    if target == "check" then
        return check() and 0 or 1
    end

    if target == "tests" then
        return tests() and 0 or 1
    end

    if target == "clean" then
        clean()
        return 0
    end

    -- Create the .love file first (always needed)
    if not create_love_file() then
        return 1
    end

    mkdir("build")

    local success = true

    if target == "all" then
        success = build_windows() and success
        success = build_mac() and success
        success = build_linux() and success
    elseif target == "windows" then
        success = build_windows()
    elseif target == "mac" then
        success = build_mac()
    elseif target == "linux" then
        success = build_linux()
    else
        log("ERROR: Unknown target: " .. target)
        print_usage()
        return 1
    end

    -- Cleanup build directory
    rmdir("build")

    if success then
        log("Build complete!")
        return 0
    else
        log("Build completed with errors")
        return 1
    end
end

-- Run
os.exit(main(arg))
